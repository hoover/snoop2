version: "3.3"

services:
  snoop-pg:
    image: postgres:9.6
    environment:
      POSTGRES_USER: snoop
      POSTGRES_DATABASE: snoop
    volumes:
      - ./volumes/snoop-pg/data:/var/lib/postgresql/data


  minio-src:
    image: minio/minio
    volumes:
      - /opt/hoover/snoop/docker-setup/collections/testdata:/data
    ports:
      - "29000:9000"
    command: server /data


  minio-blobs:
    image: minio/minio
    volumes:
      - ./snoop-blobs:/data
    ports:
      - "19000:9000"
    command: server /data


  snoop:
    image: snoop2-testing
    environment:
      - SNOOP_TESTDATA=/opt/hoover/snoop/docker-setup/collections/testdata
    volumes:
      - ..:/opt/hoover/snoop:cached
      - ./gnupg:/opt/hoover/gnupg
      - ./collections:/opt/hoover/collections
      - ./volumes/search-es-snapshots:/opt/hoover/es-snapshots
      - ../testsuite/snoop-settings.py:/opt/hoover/snoop/snoop/localsettings.py
    env_file:
      - ./settings/snoop.testing.env
    environment:
      WAIT_HOSTS: search-es:9200, snoop-pg:5432
      WAIT_HOSTS_TIMEOUT: 60
      SNOOP_DB: "postgresql://snoop:snoop@snoop-pg:5432/snoop"
      SNOOP_AMQP_URL: "amqp://snoop-rabbitmq"
    depends_on:
      - snoop-pg
      - search-es
      - snoop-tika
      - minio-source
      - minio-blobs

  snoop-worker:
    image: snoop2-testing
    env_file:
      - ./settings/snoop.testing.env
    environment:
      - SNOOP_TESTDATA=/opt/hoover/snoop/docker-setup/collections/testdata
      - SNOOP_DB=postgresql://snoop:snoop@snoop-pg:5432/snoop
      - SNOOP_AMQP_URL=amqp://snoop-rabbitmq
    volumes:
      - ..:/opt/hoover/snoop:cached
      - ./gnupg:/opt/hoover/gnupg
      - ./collections:/opt/hoover/collections
      - ./volumes/search-es-snapshots:/opt/hoover/es-snapshots
      - ../testsuite/snoop-settings.py:/opt/hoover/snoop/snoop/localsettings.py
    depends_on:
      - snoop-pg
      - search-es
      - snoop-tika
      - minio-source
      - minio-blobs
